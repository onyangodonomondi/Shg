{% extends 'base.html' %}

{% block title %}Contributions{% endblock %}

{% block content %}
<h1 class="text-center mb-4">Contributions</h1>

<div class="container mb-4">
    <form method="get">
        <div class="row">
            <!-- Event Filter -->
            <div class="col-md-3">
                <select name="event" class="form-select" onchange="this.form.submit()">
                    <option value="">All Events</option>
                    {% for event in events %}
                    <option value="{{ event.name }}" {% if event.name == selected_event %}selected{% endif %}>
                        {{ event.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Status Filter -->
            <div class="col-md-3">
                <select name="status" class="form-select" onchange="this.form.submit()">
                    <option value="">All Statuses</option>
                    <option value="Fully Contributed" {% if selected_status == 'Fully Contributed' %}selected{% endif %}>
                        Fully Contributed
                    </option>
                    <option value="Partially Contributed" {% if selected_status == 'Partially Contributed' %}selected{% endif %}>
                        Partially Contributed
                    </option>
                    <option value="No Contribution" {% if selected_status == 'No Contribution' %}selected{% endif %}>
                        No Contribution
                    </option>
                    <option value="Exempt" {% if selected_status == 'Exempt' %}selected{% endif %}>Exempt</option>
                    <option value="Deceased" {% if selected_status == 'Deceased' %}selected{% endif %}>Deceased</option>
                </select>
            </div>

            <!-- Filter Button and Export Buttons -->
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary">Filter</button>
            </div>
            <div class="col-md-4 text-end">
                <a href="{% url 'export_contributions_pdf' %}?event={{ selected_event }}&status={{ selected_status }}" class="btn btn-danger">Export to PDF</a>
                <a href="{% url 'export_contributions_excel' %}?event={{ selected_event }}&status={{ selected_status }}" class="btn btn-success">Export to Excel</a>
            </div>
        </div>
    </form>
</div>

<div class="table-responsive">
    <table class="table table-striped table-bordered">
        <thead class="thead-dark">
            <tr>
                <th scope="col">Member Name</th>
                <th scope="col">Gender</th>
                <th scope="col">Event</th>
                <th scope="col">Amount</th>
                <th scope="col">Status</th>
            </tr>
        </thead>
        <tbody>
            {% for contribution in contributions %}
            <tr>
                <td>{{ contribution.profile.user.get_full_name|default:contribution.profile.user.first_name }}</td>

                <!-- Display gender -->
                <td>{{ contribution.profile.get_gender_display }}</td>

                <td>{{ contribution.event.name }}</td>
                <td>{{ contribution.amount }} Ksh</td>

                <!-- Contribution Status Logic -->
                <td>
                    {% if contribution.profile.is_deceased %}
                        Deceased
                    {% elif contribution.profile.is_exempt %}
                        Exempt
                    {% elif contribution.profile.gender == 'F' %}
                        {% if contribution.amount >= 300 %}
                            Fully Contributed
                        {% elif contribution.amount > 0 %}
                            Partially Contributed
                        {% else %}
                            No Contribution
                        {% endif %}
                    {% elif contribution.profile.gender == 'M' %}
                        {% if contribution.amount >= 500 %}
                            Fully Contributed
                        {% elif contribution.amount > 0 %}
                            Partially Contributed
                        {% else %}
                            No Contribution
                        {% endif %}
                    {% else %}
                        <!-- Default logic for gender unknown -->
                        {% if contribution.amount >= contribution.event.required_amount %}
                            Fully Contributed
                        {% elif contribution.amount > 0 %}
                            Partially Contributed
                        {% else %}
                            No Contribution
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center">No contributions found</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination controls -->
<div class="d-flex justify-content-center">
    <nav aria-label="Page navigation">
        <ul class="pagination">
            {% if contributions.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ contributions.previous_page_number }}{% if selected_event %}&event={{ selected_event }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">&laquo;</a>
            </li>
            {% endif %}

            {% for num in contributions.paginator.page_range %}
            <li class="page-item {% if contributions.number == num %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}{% if selected_event %}&event={{ selected_event }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">{{ num }}</a>
            </li>
            {% endfor %}

            {% if contributions.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ contributions.next_page_number }}{% if selected_event %}&event={{ selected_event }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">&raquo;</a>
            </li>
            {% endif %}
        </ul>
    </nav>
</div>

{% endblock %}
